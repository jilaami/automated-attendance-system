<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>QR Attendance System</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://unpkg.com/html5-qrcode"></script>

<style>
body {
  font-family: Arial, sans-serif;
  background: #3AAFA9;
  text-align: center;
  padding: 20px;
}

#reader {
  width: 300px;
  margin: auto;
  background: white;
  padding: 10px;
  border-radius: 10px;
}

table {
  margin: 20px auto;
  width: 90%;
  border-collapse: collapse;
  background: white;
}

th {
  background: #2c3e50;
  color: white;
  padding: 10px;
}

td {
  border: 1px solid #ddd;
  padding: 8px;
}

.present { background: #2ECC71; font-weight: bold; }
.late { background: darkgoldenrod; color: white; font-weight: bold; }
.absent { background: #fecaca; font-weight: bold; }

button {
  padding: 10px 20px;
  background: green;
  color: white;
  border: none;
  border-radius: 5px;
  cursor: pointer;
}
</style>
</head>

<body>

<h2>ðŸ“¸ QR Code Attendance System</h2>
<h3>Present â‰¤ 6:30 AM | Late â‰¤ 11:59 AM | Absent â‰¥ 12:00 PM</h3>

<div id="reader"></div>

<table id="attendanceTable">
<tr>
<th>Student Name</th>
<th>Date</th>
<th>Time</th>
<th>Status</th>
</tr>
</table>

<br>
<button onclick="exportToCSV()">â¬‡ Export to Excel</button>

<script>
  
async function getPHTime() {
  const response = await fetch("https://worldtimeapi.org/api/timezone/Asia/Manila");
  const data = await response.json();
  return new Date(data.datetime);
}

const students = {
  "104769140174": "Usero Rhian Stephanie Dc.",
  "114003140240": "Calumarde Jade Amber B.",
  "158528140044": "Derigay Jhelamae P."
};

async function onScanSuccess(decodedText) {

  const table = document.getElementById("attendanceTable");
  const studentName = students[decodedText] || "Unknown Student";

  // Prevent duplicate
  for (let i = 1; i < table.rows.length; i++) {
    if (table.rows[i].cells[0].innerText === studentName) return;
  }

  const row = table.insertRow();
  const nameCell = row.insertCell(0);
  const dateCell = row.insertCell(1);
  const timeCell = row.insertCell(2);
  const statusCell = row.insertCell(3);

  const now = await getPHTime(); // âœ… REAL SERVER TIME

  const presentCutoff = new Date(now);
  presentCutoff.setHours(6, 30, 0, 0);

  const absentCutoff = new Date(now);
  absentCutoff.setHours(12, 0, 0, 0);

  let status = "";

  if (now <= presentCutoff) {
    status = "Present";
    statusCell.className = "present";
  } else if (now < absentCutoff) {
    status = "Late";
    statusCell.className = "late";
  } else {
    status = "Absent";
    statusCell.className = "absent";
  }

  nameCell.innerHTML = studentName;
  dateCell.innerHTML = now.toLocaleDateString("en-PH");
  timeCell.innerHTML = now.toLocaleTimeString("en-PH");
  statusCell.innerHTML = status;
}

const scanner = new Html5QrcodeScanner(
  "reader",
  { fps: 10, qrbox: 250 }
);

scanner.render(onScanSuccess);

function exportToCSV() {
  const table = document.getElementById("attendanceTable");
  let csv = [];

  for (let i = 0; i < table.rows.length; i++) {
    let row = [];
    for (let j = 0; j < table.rows[i].cells.length; j++) {
      row.push(table.rows[i].cells[j].innerText);
    }
    csv.push(row.join(","));
  }

  const blob = new Blob([csv.join("\n")], { type: "text/csv" });
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = "Attendance_PH_Time.csv";
  link.click();
}

</script>

</body>
</html>
